# RUNBOOK â€” Blue/Green Nginx Failover Alerts

## Purpose
This runbook explains the alerts generated by the `alert_watcher` service and the steps operators should follow when they appear.

## Alerts and Actions

### 1) Failover detected (Blue -> Green or Green -> Blue)
Meaning:
- The watcher observed that requests are now served by the other pool (X-App-Pool changed).
Action:
1. Immediately check the health of the primary container:
   - `docker ps | grep app_blue` and `docker logs app_blue`
   - `curl -sv http://localhost:8081/healthz`
2. If primary is down, inspect container logs and restart if necessary:
   - `docker restart app_blue`
3. If primary is healthy but still failing via Nginx, consider reloading Nginx config:
   - `docker exec bg_nginx nginx -s reload`
4. Post status in the incident channel and annotate the alert to suppress duplicates while investigating.

### 2) Elevated 5xx error rate
Meaning:
- The proportion of 5xx responses exceeded the configured `ERROR_RATE_THRESHOLD` over the sliding window.
Action:
1. Identify which upstream is contributing most errors. Check recent access logs:
   - `docker exec -it bg_nginx tail -n 200 /var/log/nginx/access.log`
2. Inspect the upstream container logs (app_blue/app_green) for stack traces or resource issues.
3. Consider switching traffic manually if necessary by setting `ACTIVE_POOL` and reloading Nginx, or by restarting the offending app container.
4. If this is part of a planned test, enable `MAINTENANCE_MODE=1` in `.env` to suppress alerts temporarily.

### 3) Recovery notifications
Meaning:
- The primary is serving traffic again (watcher will detect pool change back).
Action:
- Confirm application functionality and close the incident. Optionally run a smoke test:
  - `curl -i http://localhost:8080/version`

## Suppressing Alerts (Maintenance Mode)
Set `MAINTENANCE_MODE=1` in `.env` and `docker compose restart alert_watcher` to temporarily stop alerts during planned tests.

## Useful Commands
- View recent nginx access logs:
  - `docker exec bg_nginx tail -n 200 /var/log/nginx/access.log`
- Check watcher logs:
  - `docker logs -f alert_watcher`

